clear
count=0;
TLAUNCH=300.;
TF=1400.;
TS=1.;
XLONGMDEGICKM=1000.;
XLATMDEGICKM=0.;
RDESKM=10000.;
TFTOT=2000.;
ALTMKMIC=0.;
TLOFT=0.;
QEARTH=0;
TFTOT=252.+.223*RDESKM-(5.44E-6)*RDESKM*RDESKM;
TFTOT=TFTOT+TLOFT;
for TF=(TLAUNCH+60):20:(TFTOT-20),
	SWITCH=0;
	SWITCHM=0;
	ALTM=ALTMKMIC*3280.;
	TFTOTP=TFTOT;
	RDESKMP=RDESKM;
	A=2.0926E7;;
	GM=1.4077E16;
	XLONGFDEG=57.3*RDESKM*3280./A;
	XLONGMDEGIC=XLONGMDEGICKM/111.;
	XLATMDEGIC=0.;
	XLONGMDEG=XLONGMDEGIC;
	XLATMDEG=XLATMDEGIC;
	QGUID=0;
	QLAUNCH=0;
	QFIRST=1;
	XLONGTDEG=0.;
	XLATTDEG=0.;
	XLATFDEG=0.;
	TBO=0.;
	QBOOST=1;
	QBOOSTM=1;
	SWITCH=0;
	SWITCHM=0;
	T=0.;
	S=0.;
	AXT=0.;
	AYT=0.;
	ATP=0.;
	XLONGF=XLONGFDEG/57.3;
	XLATF=XLATFDEG/57.3;
	XF=A*cos(XLATF)*cos(XLONGF);
	YF=A*cos(XLATF)*sin(XLONGF);
	ZF=0.;
	XLONGT=XLONGTDEG/57.3;
	XLONGM=XLONGMDEG/57.3;;
	XLATM=XLATMDEG/57.3;
	XLATT=XLATTDEG/57.3;
	XT=A*cos(XLATT)*cos(XLONGT);
	YT=A*cos(XLATT)*sin(XLONGT);
	ZT=0.;
	XTINIT=XT;
	YTINIT=YT;
	ZTINIT=0.;
	RTINIT=sqrt(XTINIT^2+YTINIT^2+ZTINIT^2);
	XM=(A+ALTM)*cos(XLATM)*cos(XLONGM);
	YM=(A+ALTM)*cos(XLATM)*sin(XLONGM);
	ZM=0.;
	XMINIT=XM;
	YMINIT=YM;
	ZMINIT=ZM;
	RMINIT=sqrt(XMINIT^2+YMINIT^2+ZMINIT^2);
	ATP=1.;
	AXM=0.;
	AYM=0.;
	AMP=0.;
	H=.01;
	ALTTKM=(sqrt(XT^2+YT^2)-A)/3280.;
	XMD=0.;
	YMD=0.;
	ACC=0.;
	AXMGUID=0.;
	AYMGUID=0.;
	PREDERRKM=0.;
	ZEM1=0.;
	ZEM2=0.;
	ALTMKM=(sqrt(XM^2+YM^2)-A)/3280.;
	ALTTKM=(sqrt(XT^2+YT^2)-A)/3280.;
	TGOLAM=TFTOT-T;
	[VRX,VRY]=LAMBERT3D(XT,YT,ZT,TGOLAM,XF,YF,ZF,SWITCH);
	XTD=VRX;
	YTD=VRY;
	ZTD=0.;
    [XTFACT,YTFACT]=predict44(T,XT,YT,XTD,YTD,TF,TFTOT,XF,YF);
	VBOT=sqrt(XTD^2+YTD^2)/3280.;
    RTM1=XT-XM;
	RTM2=YT-YM;
	RTM=sqrt(RTM1^2+RTM2^2);
	VTM1=XTD-XMD;
	VTM2=YTD-YMD;
	VC=-(RTM1*VTM1+RTM2*VTM2)/RTM;
	while ~((T>(TLAUNCH+50.)) & VC<0. & RTM<10000.)
		if RTM<1000
			H=.0001;
		else
			H=.01;
		end
		XTOLD=XT;
		YTOLD=YT;
		XTDOLD=XTD;
		YTDOLD=YTD;
		XMOLD=XM;
		YMOLD=YM;
		XMDOLD=XMD;
		YMDOLD=YMD;
		STEP=1;
		FLAG=0;
		while STEP <=1
			if FLAG==1
				STEP=2;
				XT=XT+H*XTD;
				YT=YT+H*YTD;
				XTD=XTD+H*XTDD;
				YTD=YTD+H*YTDD;
				XM=XM+H*XMD;
				YM=YM+H*YMD;
				XMD=XMD+H*XMDD;
				YMD=YMD+H*YMDD;
				T=T+H;
			end
			TEMPBOTT=(XT^2+YT^2)^1.5;
			XTDD=-GM*XT/TEMPBOTT;
			YTDD=-GM*YT/TEMPBOTT;
			RTM1=XT-XM;
			RTM2=YT-YM;
			VTM1=XTD-XMD;
			VTM2=YTD-YMD;
			RTM=sqrt(RTM1^2+RTM2^2);
			VC=-(RTM1*VTM1+RTM2*VTM2)/RTM;
			TGO=RTM/VC;
			if T>TLAUNCH
				TEMPBOTM=(XM^2+YM^2)^1.5;
				XMDD=-GM*XM/TEMPBOTM;
				YMDD=-GM*YM/TEMPBOTM;
			else
				XMDD=0.;
				YMDD=0.;
			end
			ALTMKM=(sqrt(XM^2+YM^2)-A)/3280.;
			ALTTKM=(sqrt(XT^2+YT^2)-A)/3280.;
			ALTT=sqrt(XT^2+YT^2)-A;
			FLAG=1;
		end
		FLAG=0;
		XT=.5*(XTOLD+XT+H*XTD);
		YT=.5*(YTOLD+YT+H*YTD);
		XTD=.5*(XTDOLD+XTD+H*XTDD);
		YTD=.5*(YTDOLD+YTD+H*YTDD);
		XM=.5*(XMOLD+XM+H*XMD);
		YM=.5*(YMOLD+YM+H*YMD);
		XMD=.5*(XMDOLD+XMD+H*XMDD);
		YMD=.5*(YMDOLD+YMD+H*YMDD);
		S=S+H;
		if T>=TLAUNCH
			TGOLAMM=TF-T;
			XTF=XTFACT;
			YTF=YTFACT;
			ZTF=0.;
			QLAUNCH=1;
		end
		TGOLAMM=TF-T;
		if ((T>=TLAUNCH) & QBOOSTM==1)
			QBOOSTM=0;
			[VRXM,VRYM,VRZM]=LAMBERT3D(XM,YM,ZM,TGOLAMM,XTF,YTF,ZTF,SWITCHM);
			XMD=VRXM;
			YMD=VRYM;
			XMDOLD=VRXM;
			YMDOLD=VRYM;
			VBOM=sqrt(XMD^2+YMD^2)/3280.;
			QLAUNCH=1;
		end
		if S>=(TS-.0001)
			S=0.;
			ALTTKM=(sqrt(XT^2+YT^2)-A)/3280.;
			DISTRTKM=distance3dkm(XT,YT,ZT,XTINIT,YTINIT,ZTINIT);
			ALTMKM=(sqrt(XM^2+YM^2)-A)/3280.;
			DISTRMKM=distance3dkm(XM,YM,ZM,XTINIT,YTINIT,ZTINIT);
			VTK=sqrt(XTD^2+YTD^2)/3280.;
			ATG=sqrt(XTDD^2+YTDD^2)/32.2;
			VMKM=sqrt(XMD^2+YMD^2)/3280.;
			VTKM=sqrt(XTD^2+YTD^2)/3280.;
		end
	end
	if (VBOM<8. & RTM<1000. & ALTTKM>50.)
		count=count+1;
		ArrayTFTL(count)=TF-TLAUNCH;
		ArrayVBOM(count)=VBOM;
	end
end	
figure
plot(ArrayTFTL,ArrayVBOM),grid
xlabel('Interceptor Flight Time (s)')
ylabel('Interceptor Velocity (km/s) ')
clc
output=[ArrayTFTL',ArrayVBOM'];
save datfil.txt output -ascii
disp 'simulation finished'
		
